# 체카 결제 시스템

## 1. 서비스 개요
- 상품화 신청 접수 -> 차량 픽업 (탁송비 발생 5만) -> 입고 -> 접수 -> 서비스 선택
-> 상품화 작업 -> 홈배송 신청 -> 결제 -> 리뷰 평가   
이렇게 프로세스가 이루어집니다.
- 여기서 상품화 신청을 하고 차량 픽업을 하기위해 `탁송비`가 발생하게 됩니다.
- `탁송비` 결제를 하기 위해서 결제완료 API와 환불 API를 구현하였습니다.
- 또한 `체카의 글로벌화`가 될 가능성을 고려하여, `해외결제`도 가능하도록 구현하였습니다.
- 현재는 테스트결제만 가능합니다.

## 2. 결제 시스템 흐름
<img width="922" alt="스크린샷 2023-03-28 오후 8 03 16" src="https://user-images.githubusercontent.com/87293880/228216336-fe843c2e-5ddc-4c9b-91f7-0c601a36edfc.png">

- 사용자가 결제 요청을 하게 된다면, `가맹점`(체카 애플리케이션)에서 결제창을 요청하고 결제 요청을 최종적으로 하게됩니다.
- `가맹점`은 포트원(PG사와 연동하기 쉽게 지원하는 서비스)을 이용해서 `PG사`(여기서는 엑심베이를 사용하였습니다.)와 연동하고 결제를 최종적으로 카드사에게 결제 요청을 하게 됩니다.
- 결제에 대한 결과를 가맹점에 전달되고 결제완료 여부와 취소여부를 확인할 수 있습니다. 이렇게 결제 프로세스가 마무리됩니다.


## 3. API에 대한 설명
> 우선 API에 대해 설명하기 앞서 한가지 알아두어야 할 사실이 있습니다.   
> 프론트단에서 결제에 대한 스크립트를 작성하고 결제 완료 여부를 PG사에 전달을 하게 됩니다.    
> 이후에 결제 완료 여부에 대한 데이터들을 받아서 백엔드에 전달하게 됩니다.   
> 이러한 이유는, **결제에 대한 데이터를 데이터베이스에 저장하기 위함입니다**.   
> 현재는 기능구현에 집중하기 위해 프론트단에서는 버튼구현만 진행하였습니다.

### 결제 완료 API
- https://github.com/cheimbus/chexcar_payments/blob/main/back/src/portone/iamport.controller.ts
- 이 코드는 컨트롤러는 각 비즈니스 로직이 담겨있는 서비스와 연동하고 관리를 하게 됩니다.
- https://github.com/cheimbus/chexcar_payments/blob/main/back/src/portone/iamport.service.ts
- 이는 비즈니스 로직입니다.
- 결제 완료를 하기위해서는 앞서 말한 `프론트단에서 받은 데이터`와 `실제 결제가 이루어진 값`(포트원에서 결제 완료 시 얻는 정보)과 `비교`를 해야합니다.    
왜냐하면 중간에 누군가 `스크립트를 변경`해서 요청을 하게 된다면, 10000원 상품을 100원으로 바꿔서 요청할 수 있기 때문입니다.
- 따라서 이를 방지하기 위해 가격을 비교하고 문제가 없을 시 데이터베이스에 저장하는 식으로 구현하였습니다.
- 그리고 `네트워크 문제`가 발생할 수 있습니다. 만약에 결제 도중 와이파이가 끊어졌을 때, 실제 결제는 이루어지지 않았는데 데이터베이스에 저장되는 사태가 발생할 수 있습니다.   
 이를 방지하기위해 `웹훅`을 구현하였습니다. (배포 시에 사용가능합니다.)

### 결제 환불 API
- https://github.com/cheimbus/chexcar_payments/blob/main/back/src/portone/iamport.controller.ts
- 이 코드도 마찬가지로 같은 controller에 위치해 있습니다.
- https://github.com/cheimbus/chexcar_payments/blob/main/back/src/portone/iamport.service.ts
- `78번째 줄`부터 비즈니스 로직이 구현되어 있습니다.
- 환불을 하기위해서는 포트원에서 지원하는 결제 고유번호를 이용해서 해당 상품을 환불할 수 있습니다.
- 즉, 사용자가 상품화 신청 접수이후에 탁송비를 환불할 수 있습니다.

## 4. 사용방법
> 우선은 곧바로 결제가 가능하도록 구현되어있습니다.   
> 따라서 결제를 하면되는데, `실제 카드가 필요하지 않도록 테스트 카드를 이용해서 결제`를 할 수 있습니다.   
> `VISA : 4111-1111-1111-1111 / 12월 30년 / CVC : 123` 를 입력합니다.   
> 환불은 해당 결제 고유번호를 입력해서 요청보내면 됩니다.

## 5. 느낀점 & 포부
- 결제 시스템을 구현하면서, 체카의 결제 API를 구현해 보고싶었습니다.   
또한 조금 더 API 고도화를 진행해보고 다양한 루트로 해보고 싶다는 욕심이 생겼습니다.
- 다른 API도 구현할 수 있는 자신감이 있습니다. 포기하지 않으면 이룰 수 있는 것을 알기 때문입니다.
